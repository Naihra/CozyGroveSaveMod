<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Cosy Grove Imp Finder</title>
	<style type="text/css">
		a,label,input {		
		font-family: 'Courier New', monospace;		
		margin: 5px;
		}
		
		table, th, td {
		border:1px solid #c3c3c3;
		}		

	</style>
	<script src="./data/sorttable.js"></script>
	<script src="./data/function.js"></script>
</head>

<body>

	<h1>Cozy Grove Imp Finder</h1>	
	
	<label for="uploadSourceFile">Select your save</label><br>
	<input id="uploadSourceFile" type="file" accept=".sf">
	<br><br>		
	
	<canvas id="myCanvas" width="1000" height="920" style="border:1px solid #c3c3c3;">
		Your browser does not support the canvas element.
	</canvas>

	<div class="table">
	<table class="sortable" id="impTable" style="display:none">
	<thead>
		<tr>
			<th>#</th>
			<th>Type</th>
			<th>X</th>
			<th>Y</th>
			<th>Time</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>			
		</tr>
	</tbody>
	</table>	
	</div>
	
	<!--
	<input id="modId"   size="2">
	<select id="modType">
	<option value="typeK">Keep</option>
	<option value="typeC">Change</option>
	</select> 
	<input id="modX"    size="10">
	<input id="modY"    size="10">
	 <input id="butModify" type="button" value="Change" onclick="changeLine()" disabled="true">	
	<br>
	<input id="butSave" type="button" value="Save" onclick="save( JSON, checkSave )" disabled="true">
	<br><br>
	-->
	
	<script>
	
	checkSave = false;
	iniPaint();
	
	document.getElementById("uploadSourceFile").addEventListener("change", loadSource, false);
	
	function start( result )
	{
		if ( result )
		{
			clearCanvas();
			paintGrid();
			paintBase( true );			
			findImps();
			
			//document.getElementById("butModify").disabled = false;
			//document.getElementById("butSave").disabled = false;
		}
	}		
		
	function findImps()
	{
		var contador = 1;
		const size = 30;
	
		for( var key in json.PersistedPrefabsByID )
		{				
			var line = json.PersistedPrefabsByID[key].Value;
			contador += 1;
			
			pos_x = 4 * (line.position.x + offset_x) - (size / 2);
			pos_y = 4 * (offset_y - line.position.y) - (size / 2);
			
			ctx.font = "12px Courier New";
			ctx.textAlign = 'start';
			ctx.fillText(key, pos_x, pos_y);						
			
			var imgName = ( line.prefabName.includes("Heart") ) ? "imp_heart" : "imp_hungry";	
			loadAndDraw(rutaImp, "png", imgName, pos_x, pos_y, size, size);	
						
			var table 		= document.getElementById("impTable");
			var row 		= table.insertRow(contador);				
			var cell_number = row.insertCell(0);
			var cell_type   = row.insertCell(1);
			var cell_x 		= row.insertCell(2);
			var cell_y 		= row.insertCell(3);
			var cell_date	= row.insertCell(4);
			
			cell_number.innerHTML 	= key;
			cell_type.innerHTML 	= line.prefabName.split("_")[1];
			cell_x.innerHTML		= line.position.x;
			cell_y.innerHTML		= line.position.y;		
			
			for ( var key_d in json.DecayingObjects )
			{
				var line_d = json.DecayingObjects[key_d];
				
				if ( line_d.instanceId.Value == line.instanceId.Value )
				{					
					var date = new Date(line_d.decayTimestamp * 1000);
					var iso = date.toISOString().match(/(\d{4}\-\d{2}\-\d{2})T(\d{2}:\d{2}:\d{2})/)
					cell_date.innerHTML	=  iso[1] + ' ' + iso[2]
				}
			}						
		}
		table.deleteRow(1);		
		table.style.display = 'block';		
	}
	
	function changeLine()
	{
		var modId   = document.getElementById("modId").value;
		var modType = document.getElementById("modType").options[document.getElementById("modType").selectedIndex].text;
		var modX    = document.getElementById("modX").value;
		var modY    = document.getElementById("modY").value;
		
		var table = document.getElementById("impTable");
		
		if ( modId == "" || modId > ( table.tBodies[0].rows.length - 1) || ( modX == "" && modY == "" && modType == "Keep" ) )
		{
			alert("Nada que modificar");
			return;
		}
		
		var line = json.PersistedPrefabsByID[modId].Value;
		checkSave = true;
		
		if ( modX != "" )
		{			
			line.position.x = modX;
			table.tBodies[0].rows[modId].cells[2].innerHTML = modX;
		}
		if ( modY != "" )
		{
			line.position.y = modY;
			table.tBodies[0].rows[modId].cells[3].innerHTML = modY;
		}
		if ( modType == "Change" )
		{
			if ( table.tBodies[0].rows[modId].cells[1].innerHTML == "Hungry" )
			{
				line.prefabName = "Imps_Heartbroken_GenPrefab";
				table.tBodies[0].rows[modId].cells[1].innerHTML = "Heartbroken";
			}	
			else
			{
				line.prefabName = "Imps_Hungry_GenPrefab";
				table.tBodies[0].rows[modId].cells[1].innerHTML = "Hungry";
			}
		}	

		document.getElementById("modId").value = "";
		document.getElementById("modType").selectedIndex = 0;
		document.getElementById("modX").value = "";
		document.getElementById("modY").value = "";
		
	}	
	</script>
</body>
</html>