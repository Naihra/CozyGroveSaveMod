<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Cosy Grove Finder</title>
	<style type="text/css">
		a,label,input {		
		font-family: 'Courier New', monospace;		
		margin: 5px;
		}
	</style>
	<script src="./data/function.js"></script>
</head>

<body>

	<h1>Cozy Grove Finder</h1>	
	
	<label for="uploadSourceFile">Select your save</label><br>
	<input id="uploadSourceFile" type="file" accept=".sf">
	<br><br>	
	
	<label for="findItem">What to look for</label>
	<select id="findItem" onchange="setCustom()" disabled="true">
		<option value="findCustom">--Custom search--</option>
		<option value="findImp">Imps</option>	
		<option value="findFora">Forage</option>
		<option value="findRock">Rocks</option>
		<option value="findWild">Wild trees</option>			
		<option value="findCrit">Critters</option>				
	</select> 
	
	<input id="btFind" type="button" value="Find me!" onclick="findMe();" disabled="false">
	<input id="inputCustom" type="text" disabled="false" style="display:block">
	<br><br>
	
	<canvas id="myCanvas" width="1000" height="1000" style="border:1px solid #c3c3c3;">
		Your browser does not support the canvas element.
	</canvas>
		
	<script>		
	iniPaint();
	
	document.getElementById("uploadSourceFile").addEventListener("change", loadSource, false );
	document.getElementById("inputCustom").addEventListener("keyup", function(event) 
	{
		if ( event.keyCode === 13 )
		{
			event.preventDefault();
			findMe();
		}
	});
	
	function start( result )
	{
		if ( result )
		{
			document.getElementById("findItem").disabled = false;
			document.getElementById("btFind").disabled = false;
			document.getElementById("inputCustom").disabled = false;
			
			clearCanvas();
			paintGrid();
			paintBase( false );		
		}
		else
		{
			document.getElementById("findItem").disabled = true;
			document.getElementById("btFind").disabled = true;
			document.getElementById("inputCustom").disabled = true;
		}		
	}	
	
	function findMe()
	{
		clearCanvas();
		paintGrid();
		paintBase();
		var item = document.getElementById("findItem").options[document.getElementById("findItem").selectedIndex].value;
		
		switch (item)
		{
		case "findRock":		
		findStart("rock_", "rock");
		break;
		
		case "findWild":
		findStart("wild_");
		break;
		
		case "findImp":
		findImps();
		break;
		
		case "findCustom":
		var item = document.getElementById("inputCustom").value;
		findCustom( item );
		break;
		
		case "findFora":
		findForage();
		break;
		
		case "findCrit":
		findCritters();
		break;		
		}			
	}
	
	function findStart( item, special )
	{
		for( var key in json.ItemsOnGroundData.OnGround )
		{
			var leng = item.length;
			var line = json.ItemsOnGroundData.OnGround[key].Value;
			
			try {						
			if ( line.item.configID.Value.substring(0,leng) == item )
			{
				pos_x = 4 * (line.position.x + offset_x);
				pos_y = 4 * (offset_y - line.position.y);
				
				if ( special != null )
				{	
					var size = 50;
						
					pos_x -= size / 2;
					pos_y -= size / 2;
					
					var nameSplit  = line.item.configID.Value.split("_");	
					var imgName = nameSplit[1].concat("_", nameSplit[2], "_", line.item.state.harvestable.hasLoot );
				
					loadAndDraw(rutaRocks, "png", imgName, pos_x, pos_y, size, size);	
				} 
				else
				{		
					ctx.beginPath();
					ctx.arc(pos_x, pos_y, 6, 0, 2 * Math.PI);
					ctx.fillStyle = "black";
					ctx.fill();
					
					ctx.font = "12px Courier New";
					ctx.fillText(line.item.configID.Value, pos_x + 12, pos_y + 6); 				
				}
			}
			} catch(err) { }
		}
	}
	
	function findImps()
	{
		const size = 30;
	
		for( var key in json.PersistedPrefabsByID )
		{				
			var line = json.PersistedPrefabsByID[key].Value;
			
			if ( line.prefabName.substring(0,4) == "Imps" )
			{			
				pos_x = 4 * (line.position.x + offset_x) - (size / 2);
				pos_y = 4 * (offset_y - line.position.y) - (size / 2);
							
				var nameSplit = line.prefabName.split("_");
				var imgName = nameSplit[0].concat(nameSplit[1]);
				loadAndDraw(rutaImp, "png", imgName, pos_x, pos_y, size, size);			
			}
		}		
	}
	
	function findSkip()
	{
		const size = 30;
	
		for( var key in json.PersistedPrefabsByID )
		{				
			var line = json.PersistedPrefabsByID[key].Value;
			
			if ( line.prefabName.substring(0,4) != "Imps" )
			{			
				pos_x = 4 * (line.position.x + offset_x) - (size / 2);
				pos_y = 4 * (offset_y - line.position.y) - (size / 2);
					
				var imgName = line.data.configID;				
				loadAndDraw(rutaForage, "png", imgName, pos_x, pos_y, size, size);			
			}
		}		
	}
	
	function findCustom( item, color, image )
	{			
		if ( item != "" )
		{
			color = ( color == '' || color == null ) ? "black" : color;
			
			for( var key in json.ItemsOnGroundData.OnGround )
			{			
				var line = json.ItemsOnGroundData.OnGround[key].Value;	
				var nameSplit  = line.item.configID.Value.split("_");
				
				if ( item != "shell" || ( item == "shell" && nameSplit[nameSplit.length - 1] != "model" ) )
				{

				try {				
				if ( line.item.configID.Value.includes(item) )
				{
					pos_x = 4 * (line.position.x + offset_x);
					pos_y = 4 * (offset_y - line.position.y);
					
					if ( image != null && image != "" )
					{
						var size = 40;
						
						pos_x -= size / 2;
						pos_y -= size / 2;
					
						var imageSplit = image.split("_");						
						
						//Checks are needed for leafpiles
						if ( nameSplit.length > imageSplit[1] )
						{										
							if (  nameSplit[imageSplit[1]].substring(0,3) != "lut" )
							{
								var imgName = nameSplit[imageSplit[0]].concat("_", nameSplit[imageSplit[1]]);
							} else
							{
								var imgName = nameSplit[imageSplit[0]];
							}
						} else
						{
							var imgName = nameSplit[imageSplit[0]];
						}
						loadAndDraw(rutaForage, "png", imgName, pos_x, pos_y, size, size);							
					}
					else
					{					
						ctx.beginPath();
						ctx.arc(pos_x, pos_y, 6, 0, 2 * Math.PI);
						ctx.fillStyle = color;
						ctx.fill();
						
						ctx.font = "12px Courier New";
						ctx.fillText(line.item.configID.Value, pos_x + 12, pos_y + 6); 						
					}
				}
				} catch(err) {}
				}
			}
		}
	}	 
	
	function findCritters( collection )
	{
		for( var key in json.CrittersByID )
		{		
			var line = json.CrittersByID[key].Value;	
			
			pos_x = 4 * (line.position.x + offset_x);
			pos_y = 4 * (offset_y - line.position.y);
			
			ctx.beginPath();
			ctx.arc(pos_x, pos_y, 6, 0, 2 * Math.PI);
			ctx.fillStyle = "darkred";
			ctx.fill();
			
			ctx.font = "12px Courier New";
			ctx.fillText(line.configID.Value, pos_x + 12, pos_y + 6); 			
		}
	}
	
	function findForage()
	{
		findCustom( "shrubbery", "purple", "0_2" );
		findCustom( "mound", "brown", "0_1" );
		findCustom( "leafpile", "darkgreen", "3_4" );
		findCustom( "shell", "blue" );
		findCustom( "spirit_well" );
		findSkip();
	}
	
	function setCustom()
	{
		if ( document.getElementById("findItem").options[document.getElementById("findItem").selectedIndex].value == "findCustom" )
		{
			document.getElementById("inputCustom").disabled = false;
			document.getElementById("inputCustom").style.display = 'block';
		}
		else
		{
			document.getElementById("inputCustom").disabled = true;
			document.getElementById("inputCustom").style.display = 'none';			
		}
	}
	</script>
</body>
</html>